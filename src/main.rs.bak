use notify::{Config, RecommendedWatcher, Watcher, RecursiveMode, Result};
use std::sync::mpsc::channel;
use std::time::Duration;
use std::path::{Path, PathBuf};
use std::env;
use ctrlc;

fn get_watch_path() -> PathBuf {
    env::args().nth(1)
        .map(PathBuf::from)
        .unwrap_or_else(|| {
            dirs::home_dir()
                .map(|p| p.join("Documents"))
                .expect("Could not determine home directory")
        })
}

fn start_watcher(path: PathBuf) -> Result<()> {
    println!("Watching: {:?}", path);
    let (tx, rx) = channel();
    let config = Config::default().with_poll_interval(Duration::from_secs(2));
    let mut watcher: RecommendedWatcher = Watcher::new(tx, config)?;
    watcher.watch(&path, RecursiveMode::Recursive)?;
    
    ctrlc::set_handler(move || {
        println!("\nReceived Ctrl+C. Shutting down...");
        std::process::exit(0);
    }).expect("Error setting Ctrl-C handler");
    
    loop {
        match rx.recv() {
            Ok(event) => match event {
                Ok(ev) => {
                    for path in ev.paths {
                        println!("Changed: {:?}", path);
                    }
                }
                Err(e) => eprintln!("Watch error: {:?}", e),
            },
            Err(e) => eprintln!("Channel error: {:?}", e),
        }
    }
}

fn main() -> Result<()> {
    let path_to_watch = get_watch_path();
    start_watcher(path_to_watch)
}